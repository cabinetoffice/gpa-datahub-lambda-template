# Cookiecutter SAM for Python Lambda functions

This is a [Cookiecutter](https://github.com/audreyr/cookiecutter) template to create a Serverless App based on Serverless Application Model (SAM) and Python 3.9.

It is important to note that you should not try to `git clone` this project but use `SAM` CLI instead as ``{{cookiecutter.project_slug}}`` will be rendered based on your input and therefore all variables and files will be rendered properly.

## Requirements

**Make sure you have the following installed before you proceed**

* AWS CLI - [Install AWS CLI](https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html) configured with Administrator permission
* SAM CLI - [Install the SAM CLI](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html)
* [Python 3 installed](https://www.python.org/downloads/)
* Docker - [Install Docker community edition](https://hub.docker.com/search/?type=edition&offering=community)

## Usage

To initialise the project run the following command:

```
sam init --location gh:cabinetoffice/gpa-datahub-lambda-template
```

### First run

Build your lambda function read for deployment

`sam build`

Create the infrastructure for each env (dev/stage/prod etc)

`sam build && sam deploy --guided --capabilities CAPABILITY_NAMED_IAM`

Sample deployment settings

```
Configuring SAM deploy
======================

Looking for config file [samconfig.toml] :  Not found

Setting default arguments for 'sam deploy'
=========================================
Stack Name [sam-app]: datahub-samplefunction-dev
AWS Region [eu-west-2]:
Parameter ProjectName [datahub-samplefunction]:
Parameter DeploymentEnvironment [local]: dev
#Shows you resources changes to be deployed and require a 'Y' to initiate deploy
Confirm changes before deploy [y/N]:
#SAM needs permission to be able to create roles to connect to the resources in your template
Allow SAM CLI IAM role creation [Y/n]:
#Preserves the state of previously provisioned resources when an operation fails
Disable rollback [y/N]:
Save arguments to configuration file [Y/n]:
SAM configuration file [samconfig.toml]:
SAM configuration environment [default]: dev
```

You should now have your environment configuration setup.

Use the following below to deploy to your new environment

`sam deploy --no-confirm-changeset --no-fail-on-empty-changeset --config-env dev`

#### Modifying the pipeline

There is an example Github action file that can be modified to automatically deploy your lambda function based on which branch is being worked on.

1. Rename `.github/workflows-example` to `.github/workflows`
2. Rename `sam-pipeline-example.yml` to `sam-pipeline-$YOUR_ENV.yml`
3. Update any `$` reference with your own values
   1. `$YOUR_ENV` - `dev/stage/prod`. Ensure branch name matches env name.
   2. `$ROLE_TO_ASSUME` - ARN of the role that was created when you ran `sam deploy` above.

Add your changed pipeline to  git and push to Github. Your pipeline should now be active.

## Options

Option | Description
------------------------------------------------- | ---------------------------------------------------------------------------------
`include_safe_deployment` | Sends by default 10% of traffic for every 1 minute to a newly deployed function using [CodeDeploy + SAM integration](https://github.com/awslabs/serverless-application-model/blob/master/docs/safe_lambda_deployments.rst) - Linear10PercentEvery1Minute

## Use the SAM CLI to build and test locally

Whenever you change your application code, you'll have to run build command:

```bash
{{ cookiecutter.project_name }}$ sam build --use-container
```

The SAM CLI installs dependencies defined in `hello_world/requirements.txt`, creates a deployment package, and saves it in the `.aws-sam/build` folder.

Test a single function by invoking it directly with a test event:

```bash
{{ cookiecutter.project_name }}$ sam local invoke HelloWorldFunction --event events/hello.json
```

> An event is a JSON document that represents the input that the function receives from the event source. Test events are included in the `events` folder in this project.

The SAM CLI reads the application template to determine the API's routes and the functions that they invoke. The `Events` property on each function's definition includes the route and method for each path.

## Fetch, tail, and filter Lambda function logs

To simplify troubleshooting, SAM CLI has a command called `sam logs`. `sam logs` lets you fetch logs generated by your deployed Lambda function from the command line. In addition to printing the logs on the terminal, this command has several nifty features to help you quickly find the bug.

`NOTE`: This command works for all AWS Lambda functions; not just the ones you deploy using SAM.

```bash
{{ cookiecutter.project_name }}$ sam logs -n HelloWorldFunction --stack-name <Name-of-your-deployed-stack> --tail
```

You can find more information and examples about filtering Lambda function logs in the [SAM CLI Documentation](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-logging.html).

## Cleanup

To delete the sample application that you created, use the AWS CLI. Assuming you used your project name for the stack name, you can run the following:

```bash
{{ cookiecutter.project_name }}$ aws cloudformation delete-stack --stack-name {{ cookiecutter.project_name }}
```

# Credits

* This project has been generated with [Cookiecutter](https://github.com/audreyr/cookiecutter)
* [Bruno Alla's Lambda function template](https://github.com/browniebroke/cookiecutter-lambda-function)

License
-------

This project is licensed under the terms of the [MIT License with no attribution](/LICENSE)
